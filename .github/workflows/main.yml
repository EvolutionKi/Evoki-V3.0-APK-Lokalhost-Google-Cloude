name: Evoki V3.0 CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. Backend Validation (Python)
  backend-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f app/temple/requirements.txt ]; then pip install -r app/temple/requirements.txt; fi
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest flake8 watchdog

      - name: Lint with flake8
        run: |
          # Stop only on Syntax Errors (E9, F63, etc.) - permissive linting
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Syntax Check Tooling Scripts
        # Ensure our critical daemons at least compile
        run: |
          python -m py_compile tooling/scripts/daemons/pending_status_watcher.py
          python -m py_compile tooling/scripts/daemons/compliance_enforcer.py
          python -m py_compile tooling/scripts/daemons/context_watcher.py

  # 2. Frontend Validation (Build Check)
  frontend-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./app/interface
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/interface/package-lock.json

      - name: Install Frontend Dependencies
        # Only run if package.json exists to avoid workflow failure on backend-only repos
        if: hashFiles('package.json') != ''
        run: npm ci

      - name: Build Frontend
        # Try building if configured
        if: hashFiles('package.json') != ''
        run: npm run build --if-present
